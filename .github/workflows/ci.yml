# CI Workflow for PACS Bridge
# Multi-platform, multi-compiler build and test
#
# Based on pacs_system CI patterns for kcenon ecosystem consistency
#
# Note: Uses Ubuntu 24.04 for GCC 13+ support which provides std::format
# (required by logger_system dependency)
#
# Test Suites:
#   Unit Tests (Phase 1): hl7_test, mapping_test, router_test, cache_test,
#                         mllp_test, config_test, security_test, tls_test,
#                         health_check_test, performance_test, load_test
#   Integration Tests (Phase 2, Issue #29):
#     - mpps_integration_test    : MPPS N-CREATE/N-SET message flows
#     - queue_persistence_test   : Message queue recovery scenarios
#     - failover_test            : RIS failover routing
#     - stress_test              : High volume load testing

name: CI

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

# Ensure only one workflow runs per branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Documentation validation job
  docs:
    name: Validate Documentation
    runs-on: ubuntu-24.04
    timeout-minutes: 10

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Check markdown files
      run: |
        echo "=== Checking documentation structure ==="
        find docs -name "*.md" -type f | wc -l
        echo ""
        echo "=== Documentation files ==="
        find docs -name "*.md" -type f | sort

    - name: Validate links (basic)
      run: |
        echo "=== Checking for broken internal links ==="
        # Check for common broken link patterns
        find docs -name "*.md" -exec grep -l '\[.*\](.*)' {} \; | head -20

  # Multi-platform build and test job
  build:
    name: ${{ matrix.os }} / ${{ matrix.compiler }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60

    env:
      BUILD_TYPE: Release

    strategy:
      fail-fast: false
      matrix:
        include:
          # Ubuntu 24.04 provides GCC 13+ with std::format support
          - os: ubuntu-24.04
            compiler: gcc
          - os: ubuntu-24.04
            compiler: clang
          - os: macos-14
            compiler: clang
          # Windows 2022 with MSVC for cross-platform compatibility
          - os: windows-2022
            compiler: msvc

    steps:
    - name: Checkout pacs_bridge
      uses: actions/checkout@v4
      with:
        path: pacs_bridge

    # Cache kcenon ecosystem dependencies
    # Cache key includes version suffix to force refresh when dependencies update
    # v2: Updated for common_system C++20 Concepts support (Issue #70)
    - name: Cache kcenon dependencies
      uses: actions/cache@v4
      with:
        path: |
          common_system
          thread_system
          logger_system
          container_system
          network_system
          monitoring_system
          pacs_system
        key: kcenon-deps-v2-${{ runner.os }}-${{ hashFiles('pacs_bridge/CMakeLists.txt') }}
        restore-keys: |
          kcenon-deps-v2-${{ runner.os }}-

    - name: Checkout dependencies (Unix)
      if: runner.os != 'Windows'
      run: |
        # Clone dependencies as siblings to pacs_bridge in $GITHUB_WORKSPACE
        # Only clone if not cached
        [ -d common_system ] || git clone --depth 1 https://github.com/kcenon/common_system.git
        [ -d thread_system ] || git clone --depth 1 https://github.com/kcenon/thread_system.git
        [ -d logger_system ] || git clone --depth 1 https://github.com/kcenon/logger_system.git
        [ -d container_system ] || git clone --depth 1 https://github.com/kcenon/container_system.git
        [ -d network_system ] || git clone --depth 1 https://github.com/kcenon/network_system.git
        [ -d monitoring_system ] || git clone --depth 1 https://github.com/kcenon/monitoring_system.git
        [ -d pacs_system ] || git clone --depth 1 https://github.com/kcenon/pacs_system.git

    - name: Checkout dependencies (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Clone dependencies only if not cached
        if (-not (Test-Path common_system)) { git clone --depth 1 https://github.com/kcenon/common_system.git }
        if (-not (Test-Path thread_system)) { git clone --depth 1 https://github.com/kcenon/thread_system.git }
        if (-not (Test-Path logger_system)) { git clone --depth 1 https://github.com/kcenon/logger_system.git }
        if (-not (Test-Path container_system)) { git clone --depth 1 https://github.com/kcenon/container_system.git }
        if (-not (Test-Path network_system)) { git clone --depth 1 https://github.com/kcenon/network_system.git }
        if (-not (Test-Path monitoring_system)) { git clone --depth 1 https://github.com/kcenon/monitoring_system.git }
        if (-not (Test-Path pacs_system)) { git clone --depth 1 https://github.com/kcenon/pacs_system.git }

    - name: Install dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        # Retry logic for apt-get (network reliability)
        for i in 1 2 3; do
          sudo apt update && break || sleep 10
        done
        sudo apt install -y cmake build-essential ninja-build pkg-config
        sudo apt install -y libsqlite3-dev libssl-dev libfmt-dev
        sudo apt install -y libgtest-dev libgmock-dev
        if [ "${{ matrix.compiler }}" = "clang" ]; then
          # Clang + libc++ for full C++23 support (std::expected)
          sudo apt install -y clang lld libc++-dev libc++abi-dev
        fi

    - name: Install dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install ninja pkg-config sqlite3 openssl@3 googletest fmt

    - name: Setup MSVC (Windows)
      if: runner.os == 'Windows'
      uses: ilammy/msvc-dev-cmd@v1

    - name: Install Ninja (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        choco install ninja -y
        ninja --version

    - name: Install dependencies (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Use pre-installed vcpkg on GitHub Actions runner
        # Note: VCPKG_ROOT is already set to C:\vcpkg on windows-2022 runners
        Write-Host "Using vcpkg from: $env:VCPKG_ROOT"
        vcpkg integrate install
        vcpkg install sqlite3:x64-windows openssl:x64-windows fmt:x64-windows gtest:x64-windows

    # Tests enabled (Issue #6 - Test Framework Setup completed)
    - name: Configure CMake (Unix)
      if: runner.os != 'Windows'
      working-directory: pacs_bridge
      run: |
        # For clang on Linux, use libc++ for better C++23 support
        # This ensures ABI compatibility with GoogleTest built from source
        # Note: BRIDGE_STANDALONE_BUILD=ON (default) excludes Event Bus code
        # which requires common_system's Event Bus. Full ecosystem build with
        # Event Bus integration will be tested separately when kcenon ecosystem
        # dependency management is resolved. See Issue #142 for details.
        if [ "${{ matrix.compiler }}" = "clang" ] && [ "${{ runner.os }}" = "Linux" ]; then
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_COMPILE_WARNING_AS_ERROR=OFF \
            -DBRIDGE_BUILD_TESTS=ON \
            -DBRIDGE_BUILD_EXAMPLES=OFF \
            -DBRIDGE_BUILD_HL7=ON \
            -DBRIDGE_BUILD_FHIR=OFF \
            -DCMAKE_C_COMPILER=clang \
            -DCMAKE_CXX_COMPILER=clang++ \
            "-DCMAKE_CXX_FLAGS=-stdlib=libc++" \
            "-DCMAKE_EXE_LINKER_FLAGS=-stdlib=libc++ -lc++abi"
        else
          cmake -B build \
            -G Ninja \
            -DCMAKE_BUILD_TYPE=$BUILD_TYPE \
            -DCMAKE_COMPILE_WARNING_AS_ERROR=OFF \
            -DBRIDGE_BUILD_TESTS=ON \
            -DBRIDGE_BUILD_EXAMPLES=OFF \
            -DBRIDGE_BUILD_HL7=ON \
            -DBRIDGE_BUILD_FHIR=OFF \
            -DCMAKE_C_COMPILER=${{ matrix.compiler == 'gcc' && 'gcc' || 'clang' }} \
            -DCMAKE_CXX_COMPILER=${{ matrix.compiler == 'gcc' && 'g++' || 'clang++' }}
        fi

    # Tests enabled (Issue #6 - Test Framework Setup completed)
    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      working-directory: pacs_bridge
      shell: pwsh
      run: |
        # Refresh PATH to include Ninja from chocolatey
        $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

        # Note: BRIDGE_STANDALONE_BUILD=ON (default) - see Issue #142
        # Use cl.exe (MSVC) explicitly to ensure compatibility with vcpkg packages
        cmake -B build `
          -G Ninja `
          -DCMAKE_BUILD_TYPE=Release `
          -DCMAKE_COMPILE_WARNING_AS_ERROR=OFF `
          -DBRIDGE_BUILD_TESTS=ON `
          -DBRIDGE_BUILD_EXAMPLES=OFF `
          -DBRIDGE_BUILD_HL7=ON `
          -DBRIDGE_BUILD_FHIR=OFF `
          -DCMAKE_C_COMPILER=cl `
          -DCMAKE_CXX_COMPILER=cl `
          -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
          -DVCPKG_MANIFEST_MODE=OFF

    - name: Build
      working-directory: pacs_bridge
      run: cmake --build build --parallel

    - name: Run tests
      working-directory: pacs_bridge
      run: |
        cd build
        ctest --output-on-failure --timeout 300
      continue-on-error: true

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-${{ matrix.os }}-${{ matrix.compiler }}
        path: |
          pacs_bridge/build/Testing/
          pacs_bridge/build/**/*.log
        retention-days: 7
        if-no-files-found: ignore

  # Code coverage job (Ubuntu GCC only)
  coverage:
    name: Code Coverage
    runs-on: ubuntu-24.04
    timeout-minutes: 60
    needs: build

    steps:
    - name: Checkout pacs_bridge
      uses: actions/checkout@v4
      with:
        path: pacs_bridge

    # Cache key v2 for C++20 Concepts support (Issue #70)
    - name: Cache kcenon dependencies
      uses: actions/cache@v4
      with:
        path: |
          common_system
          thread_system
          logger_system
          container_system
          network_system
          monitoring_system
          pacs_system
        key: kcenon-deps-v2-Linux-${{ hashFiles('pacs_bridge/CMakeLists.txt') }}
        restore-keys: |
          kcenon-deps-v2-Linux-

    - name: Checkout dependencies
      run: |
        [ -d common_system ] || git clone --depth 1 https://github.com/kcenon/common_system.git
        [ -d thread_system ] || git clone --depth 1 https://github.com/kcenon/thread_system.git
        [ -d logger_system ] || git clone --depth 1 https://github.com/kcenon/logger_system.git
        [ -d container_system ] || git clone --depth 1 https://github.com/kcenon/container_system.git
        [ -d network_system ] || git clone --depth 1 https://github.com/kcenon/network_system.git
        [ -d monitoring_system ] || git clone --depth 1 https://github.com/kcenon/monitoring_system.git
        [ -d pacs_system ] || git clone --depth 1 https://github.com/kcenon/pacs_system.git

    - name: Install dependencies
      run: |
        for i in 1 2 3; do
          sudo apt update && break || sleep 10
        done
        sudo apt install -y cmake build-essential ninja-build pkg-config
        sudo apt install -y libsqlite3-dev libssl-dev libfmt-dev
        sudo apt install -y libgtest-dev libgmock-dev
        sudo apt install -y lcov

    # Tests enabled (Issue #6 - Test Framework Setup completed)
    # Coverage reports include unit test coverage
    # Note: BRIDGE_STANDALONE_BUILD=ON (default) - see Issue #142
    - name: Configure CMake with coverage
      working-directory: pacs_bridge
      run: |
        cmake -B build \
          -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBRIDGE_ENABLE_COVERAGE=ON \
          -DBRIDGE_BUILD_TESTS=ON \
          -DBRIDGE_BUILD_EXAMPLES=OFF \
          -DBRIDGE_BUILD_HL7=ON \
          -DBRIDGE_BUILD_FHIR=OFF

    - name: Build
      working-directory: pacs_bridge
      run: cmake --build build --parallel

    - name: Run tests for coverage
      working-directory: pacs_bridge/build
      run: |
        ctest --output-on-failure --timeout 600 || true

    - name: Generate coverage report
      working-directory: pacs_bridge
      run: |
        lcov --capture --directory build --output-file coverage.info --ignore-errors mismatch,empty || true
        if [ -f coverage.info ]; then
          lcov --remove coverage.info '/usr/*' '*/tests/*' '*/examples/*' '*/build/_deps/*' --output-file coverage.info --ignore-errors unused,empty || true
          lcov --list coverage.info || echo "No coverage data available"
        else
          echo "No coverage data generated"
        fi

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: pacs_bridge/coverage.info
        flags: unittests
        name: pacs_bridge-coverage
        fail_ci_if_error: false
      continue-on-error: true

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          pacs_bridge/coverage.info
        retention-days: 7

    - name: Coverage summary
      working-directory: pacs_bridge
      run: |
        echo "## Coverage Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Phase 0: Establishing baseline coverage" >> $GITHUB_STEP_SUMMARY
        echo "Target: 80% coverage by Phase 5" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        lcov --list coverage.info >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Coverage data not available" >> $GITHUB_STEP_SUMMARY
