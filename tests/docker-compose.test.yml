# Docker Compose configuration for EMR integration tests
#
# Usage:
#   docker-compose -f tests/docker-compose.test.yml up -d
#   # Run tests
#   docker-compose -f tests/docker-compose.test.yml down
#
# Services:
#   - hapi-fhir: HAPI FHIR R4 server for EMR integration testing
#   - mock-oauth2: Mock OAuth2 server for authentication testing
#
# @see https://github.com/kcenon/pacs_bridge/issues/123

version: '3.8'

services:
  # HAPI FHIR R4 Server
  # Provides a fully compliant FHIR R4 server for testing
  # Use specific version for stability (latest can cause inconsistent test results)
  hapi-fhir:
    image: hapiproject/hapi:v7.6.0
    container_name: pacs-bridge-test-hapi-fhir
    ports:
      - "8080:8080"
    environment:
      # Server configuration (use underscores, HAPI converts to dots)
      - hapi.fhir.server_address=http://localhost:8080/fhir
      - hapi.fhir.fhir_version=R4
      - hapi.fhir.allow_multiple_delete=true
      - hapi.fhir.allow_external_references=true
      - hapi.fhir.reuse_cached_search_results_millis=60000
      # Validation settings (relaxed for testing)
      - hapi.fhir.validation.enabled=false
      # Logging
      - hapi.fhir.narratives_enabled=false
      # JVM settings - use JAVA_TOOL_OPTIONS (not JAVA_OPTS) for Docker
      - JAVA_TOOL_OPTIONS=-Xms256m -Xmx1024m -XX:+UseG1GC -XX:MaxGCPauseMillis=200
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8080/fhir/metadata"]
      interval: 15s
      timeout: 10s
      retries: 12
      start_period: 60s
    networks:
      - test-network
    volumes:
      - hapi-fhir-data:/app/target

  # Mock OAuth2 Server (optional)
  # Provides OAuth2 endpoints for authentication testing
  mock-oauth2:
    image: ghcr.io/navikt/mock-oauth2-server:0.5.6
    container_name: pacs-bridge-test-mock-oauth2
    ports:
      - "8081:8080"
    environment:
      - SERVER_PORT=8080
      - LOG_LEVEL=INFO
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/.well-known/openid-configuration"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - test-network
    profiles:
      - oauth2

networks:
  test-network:
    driver: bridge

volumes:
  hapi-fhir-data:
    driver: local
