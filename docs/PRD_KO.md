# 제품 요구사항 정의서 - PACS Bridge

> **버전:** 0.2.0.0
> **최종 수정일:** 2026-02-08
> **언어:** [English](PRD.md) | **한국어**

---

## 목차

- [개요](#개요)
- [제품 비전](#제품-비전)
- [대상 사용자](#대상-사용자)
- [기능 요구사항](#기능-요구사항)
- [비기능 요구사항](#비기능-요구사항)
- [시스템 아키텍처 요구사항](#시스템-아키텍처-요구사항)
- [프로토콜 적합성 요구사항](#프로토콜-적합성-요구사항)
- [통합 요구사항](#통합-요구사항)
- [보안 요구사항](#보안-요구사항)
- [성능 요구사항](#성능-요구사항)
- [개발 단계](#개발-단계)
- [성공 지표](#성공-지표)
- [위험 요소 및 대응방안](#위험-요소-및-대응방안)
- [부록](#부록)

---

## 개요

### 제품명
PACS Bridge (HIS/RIS 통합 게이트웨이)

### 제품 설명
PACS Bridge는 병원정보시스템(HIS)과 영상의학정보시스템(RIS)을 PACS(의료영상저장전송시스템)와 연결하는 C++20 기반 통합 게이트웨이입니다. HL7 v2.x/FHIR 메시징 프로토콜과 DICOM 서비스 간의 변환을 수행하여 영상의학과의 원활한 워크플로우 통합을 지원합니다.

### 핵심 차별점
- **듀얼 프로토콜 지원**: HL7 v2.x (레거시)와 FHIR R4 (최신) 게이트웨이 동시 지원
- **pacs_system 완전 통합**: pacs_system MWL/MPPS 서비스와 네이티브 연동
- **IHE SWF 준수**: IHE Scheduled Workflow 통합 프로파일 준수
- **프로덕션 품질**: 검증된 kcenon 에코시스템 인프라 기반
- **외부 의존성 제로**: 에코시스템 컴포넌트만 사용하는 순수 C++20 구현

---

## 제품 비전

### 비전 선언문
레거시 HIS/RIS 시스템과 최신 PACS 인프라를 원활하게 연결하는 안정적이고 고성능인 통합 브릿지를 제공하여, 영상의학과의 워크플로우 단절을 해소하고 수작업 데이터 입력 오류를 줄입니다.

### 전략적 목표

| 목표 | 설명 | 성공 기준 |
|------|------|-----------|
| **상호운용성** | HL7와 DICOM 프로토콜 연결 | 100% HL7-DICOM 메시지 변환 |
| **레거시 지원** | 기존 HIS/RIS 시스템 지원 | HL7 v2.3 ~ v2.5.1 호환 |
| **현대화** | FHIR 기반 통합 지원 | FHIR R4 ImagingStudy, ServiceRequest |
| **신뢰성** | 메시지 전달 보장 | 메시지 손실 제로, 배달 보장 |
| **성능** | 대량 메시지 처리 | ≥500 메시지/초 처리량 |

---

## 대상 사용자

### 주요 사용자

#### 1. 의료 통합 엔지니어
- **프로필**: 병원 시스템을 통합하는 IT 전문가
- **요구사항**:
  - 명확한 HL7/DICOM 매핑 문서
  - 설정 가능한 메시지 라우팅
  - 포괄적인 로깅 및 디버깅
- **불편 사항**:
  - 복잡한 멀티벤더 환경
  - 일관성 없는 HL7 구현
  - 제한된 디버깅 도구

#### 2. 영상의학과 IT 관리자
- **프로필**: 영상의학과 워크플로우 관리 담당자
- **요구사항**:
  - 신뢰할 수 있는 워크리스트 동기화
  - 실시간 검사 상태 업데이트
  - 최소한의 설정 부담
- **불편 사항**:
  - 수동 워크리스트 입력 오류
  - 지연된 상태 알림
  - 업데이트 중 시스템 다운타임

#### 3. 의료장비 벤더
- **프로필**: 모달리티 소프트웨어 개발 회사
- **요구사항**:
  - 표준 MWL 쿼리 인터페이스
  - MPPS 알림 엔드포인트
  - 통합 테스트 도구
- **불편 사항**:
  - 다양한 RIS 구현
  - 프로토콜 호환성 문제

### 보조 사용자

#### 병원 시스템 관리자
- 메시지 큐 및 시스템 상태 모니터링
- 라우팅 규칙 및 페일오버 설정
- 보안 인증서 관리

#### 임상 직원 (간접 사용자)
- 워크리스트에서 환자 선택하는 기사
- 적시에 보고서를 받는 영상의학과 전문의
- 결과에 접근하는 의뢰 의사

---

## 기능 요구사항

### FR-1: HL7 v2.x 게이트웨이

#### FR-1.1: 메시지 파싱
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-1.1.1 | HL7 v2.x 메시지 파싱 (v2.3 ~ v2.5.1) | 필수 | 1 |
| FR-1.1.2 | 표준 구분자 및 이스케이프 시퀀스 지원 | 필수 | 1 |
| FR-1.1.3 | 반복 필드 및 컴포넌트 처리 | 필수 | 1 |
| FR-1.1.4 | 스키마 기반 메시지 구조 검증 | 권장 | 2 |
| FR-1.1.5 | Z-세그먼트(사용자 정의 세그먼트) 지원 | 권장 | 2 |

#### FR-1.2: 메시지 유형
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-1.2.1 | ADT^A01, A04, A08, A40 처리 (환자 등록) | 필수 | 1 |
| FR-1.2.2 | ORM^O01 처리 (오더 관리) | 필수 | 1 |
| FR-1.2.3 | ORU^R01 생성 (검사 결과) | 필수 | 2 |
| FR-1.2.4 | SIU^S12-S15 처리 (스케줄링) | 권장 | 2 |
| FR-1.2.5 | ACK 응답 생성 | 필수 | 1 |

#### FR-1.3: MLLP 전송
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-1.3.1 | MLLP 서버(리스너) 구현 | 필수 | 1 |
| FR-1.3.2 | MLLP 클라이언트(송신자) 구현 | 필수 | 1 |
| FR-1.3.3 | 지속적/일시적 연결 지원 | 필수 | 1 |
| FR-1.3.4 | 메시지 프레이밍 처리 (VT, FS, CR) | 필수 | 1 |
| FR-1.3.5 | TLS 기반 MLLP 지원 | 권장 | 2 |

---

### FR-2: FHIR R4 게이트웨이

#### FR-2.1: RESTful API
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-2.1.1 | FHIR REST 서버 구현 | 권장 | 3 |
| FR-2.1.2 | 리소스 CRUD 작업 지원 | 권장 | 3 |
| FR-2.1.3 | 검색 파라미터 구현 | 권장 | 3 |
| FR-2.1.4 | JSON 및 XML 포맷 지원 | 권장 | 3 |
| FR-2.1.5 | 대용량 결과셋 페이지네이션 | 선택 | 4 |

#### FR-2.2: 영상의학 리소스
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-2.2.1 | Patient 리소스 지원 | 권장 | 3 |
| FR-2.2.2 | ServiceRequest (영상 오더) 지원 | 권장 | 3 |
| FR-2.2.3 | ImagingStudy 리소스 지원 | 권장 | 3 |
| FR-2.2.4 | DiagnosticReport 리소스 지원 | 권장 | 3 |
| FR-2.2.5 | Task (워크리스트 항목) 지원 | 선택 | 4 |

---

### FR-3: DICOM 통합

#### FR-3.1: Modality Worklist 브릿지
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-3.1.1 | HL7 ORM을 DICOM MWL 항목으로 변환 | 필수 | 1 |
| FR-3.1.2 | 환자 정보 매핑 (PID → Patient Module) | 필수 | 1 |
| FR-3.1.3 | 오더 정보 매핑 (ORC/OBR → SPS) | 필수 | 1 |
| FR-3.1.4 | Study Instance UID 사전 할당 지원 (ZDS) | 필수 | 1 |
| FR-3.1.5 | 오더 취소 처리 (ORC-1=CA) | 필수 | 1 |
| FR-3.1.6 | 오더 수정 처리 (ORC-1=XO) | 권장 | 2 |

#### FR-3.2: MPPS 알림
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-3.2.1 | MPPS N-CREATE 알림 수신 | 필수 | 2 |
| FR-3.2.2 | MPPS IN PROGRESS를 HL7 ORM 상태로 변환 | 필수 | 2 |
| FR-3.2.3 | MPPS N-SET (COMPLETED) 알림 수신 | 필수 | 2 |
| FR-3.2.4 | MPPS COMPLETED를 HL7 ORM 상태로 변환 | 필수 | 2 |
| FR-3.2.5 | MPPS DISCONTINUED 처리 | 권장 | 2 |

---

### FR-4: 메시지 라우팅

#### FR-4.1: 인바운드 라우팅
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-4.1.1 | ADT 메시지를 환자 캐시로 라우팅 | 필수 | 1 |
| FR-4.1.2 | ORM 메시지를 MWL 관리자로 라우팅 | 필수 | 1 |
| FR-4.1.3 | 메시지 유형 및 트리거 기반 라우팅 | 필수 | 1 |
| FR-4.1.4 | 조건부 라우팅 규칙 지원 | 권장 | 2 |

#### FR-4.2: 아웃바운드 라우팅
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-4.2.1 | MPPS 알림을 RIS로 라우팅 | 필수 | 2 |
| FR-4.2.2 | ORU 메시지를 설정된 엔드포인트로 라우팅 | 권장 | 3 |
| FR-4.2.3 | 다중 목적지 라우팅 지원 | 권장 | 2 |
| FR-4.2.4 | 페일오버 라우팅 구현 | 권장 | 3 |

#### FR-4.3: 메시지 큐
| ID | 요구사항 | 우선순위 | 단계 |
|----|----------|----------|------|
| FR-4.3.1 | 신뢰할 수 있는 전달을 위한 아웃바운드 메시지 큐잉 | 필수 | 1 |
| FR-4.3.2 | 지수 백오프를 사용한 재시도 구현 | 필수 | 1 |
| FR-4.3.3 | 메시지 우선순위 지원 | 권장 | 2 |
| FR-4.3.4 | 장애 복구를 위한 큐 영속화 | 권장 | 2 |

---

## 비기능 요구사항

### NFR-1: 성능

| ID | 요구사항 | 목표 | 측정 방법 |
|----|----------|------|-----------|
| NFR-1.1 | 메시지 처리량 | ≥500 msg/s | 처리된 HL7 메시지 |
| NFR-1.2 | 메시지 지연시간 (P95) | <50 ms | 종단간 처리 시간 |
| NFR-1.3 | MWL 쿼리 응답 | <100 ms | DICOM C-FIND → MWL 항목 |
| NFR-1.4 | 동시 연결 | ≥50 | 동시 HL7 연결 |
| NFR-1.5 | 메모리 기준선 | <200 MB | 유휴 시스템 메모리 |
| NFR-1.6 | CPU 사용률 | <20% | 유휴 시스템 부하 |

### NFR-2: 신뢰성

| ID | 요구사항 | 목표 | 측정 방법 |
|----|----------|------|-----------|
| NFR-2.1 | 시스템 가동시간 | 99.9% | 월별 가용성 |
| NFR-2.2 | 메시지 전달 | 100% | 메시지 손실 제로 |
| NFR-2.3 | 우아한 성능 저하 | 필수 | 고부하 상황 |
| NFR-2.4 | 오류 복구 | 자동 | 연결 실패 시 |
| NFR-2.5 | 큐 영속성 | 필수 | 재시작 후 유지 |

### NFR-3: 확장성

| ID | 요구사항 | 목표 | 측정 방법 |
|----|----------|------|-----------|
| NFR-3.1 | 수평 확장 | 지원 | 다중 인스턴스 |
| NFR-3.2 | 일일 메시지 볼륨 | ≥100K | 일일 메시지 |
| NFR-3.3 | MWL 항목 용량 | ≥10K | 활성 워크리스트 항목 |
| NFR-3.4 | 연결 풀링 | 효율적 | 연결 재사용 |

### NFR-4: 보안

| ID | 요구사항 | 목표 | 측정 방법 |
|----|----------|------|-----------|
| NFR-4.1 | TLS 지원 | TLS 1.2/1.3 | MLLP/FHIR |
| NFR-4.2 | 접근 로깅 | 완전함 | 모든 트랜잭션 |
| NFR-4.3 | 감사 추적 | HIPAA 준수 | PHI 접근 |
| NFR-4.4 | 입력 검증 | 100% | 모든 네트워크 입력 |
| NFR-4.5 | 인증서 관리 | X.509 | 클라이언트/서버 인증 |

### NFR-5: 유지보수성

| ID | 요구사항 | 목표 | 측정 방법 |
|----|----------|------|-----------|
| NFR-5.1 | 코드 커버리지 | ≥80% | 라인 커버리지 |
| NFR-5.2 | 문서화 | 완전함 | 모든 공개 API |
| NFR-5.3 | CI/CD 파이프라인 | 100% 성공 | 모든 플랫폼 |
| NFR-5.4 | 설정 외부화 | 완료 | 설정 변경에 코드 수정 불필요 |
| NFR-5.5 | 로깅 | 구조화 | JSON 형식 |

---

## 시스템 아키텍처 요구사항

### SAR-1: 컴포넌트 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            PACS Bridge                                    │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌─────────────────────┐    ┌────────────────┐    ┌──────────────────┐  │
│  │    HL7 게이트웨이    │    │  메시지 라우터  │    │   FHIR 게이트웨이 │  │
│  │                     │    │                │    │                  │  │
│  │  ┌───────────────┐  │    │  ┌──────────┐  │    │  ┌────────────┐  │  │
│  │  │ MLLP 서버     │──┼───►│  │ 인바운드 │  │    │  │ REST 서버  │  │  │
│  │  └───────────────┘  │    │  │ 핸들러   │  │    │  └────────────┘  │  │
│  │  ┌───────────────┐  │    │  └──────────┘  │    │  ┌────────────┐  │  │
│  │  │ MLLP 클라이언트│◄─┼────│  ┌──────────┐  │◄───│  │ 구독자     │  │  │
│  │  └───────────────┘  │    │  │ 아웃바운드│  │    │  └────────────┘  │  │
│  │  ┌───────────────┐  │    │  │ 큐       │  │    └──────────────────┘  │
│  │  │ 메시지 파서   │  │    │  └──────────┘  │                          │
│  │  └───────────────┘  │    └────────────────┘                          │
│  └─────────────────────┘             │                                   │
│                                      │                                   │
│  ┌───────────────────────────────────▼───────────────────────────────┐  │
│  │                        변환 레이어                                  │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌───────────┐  │  │
│  │  │ HL7→DICOM   │  │ DICOM→HL7   │  │ HL7→FHIR    │  │ FHIR→DICOM│  │  │
│  │  │ 매퍼        │  │ 매퍼        │  │ 매퍼        │  │ 매퍼      │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └───────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                      │                                   │
│  ┌───────────────────────────────────▼───────────────────────────────┐  │
│  │                      pacs_system 어댑터                            │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────────┐  │  │
│  │  │ MWL 클라이언트│  │ MPPS 핸들러 │  │ 환자 캐시                    │  │  │
│  │  └─────────────┘  └─────────────┘  └─────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────┘  │
│                                      │                                   │
└──────────────────────────────────────┼───────────────────────────────────┘
                                       │
                    ┌──────────────────┼──────────────────┐
                    │                  │                  │
           ┌────────▼────────┐  ┌──────▼──────┐  ┌────────▼────────┐
           │   pacs_system   │  │  HIS / RIS  │  │   EMR / EHR     │
           │  (DICOM MWL/MPPS)│  │  (HL7 v2.x) │  │   (FHIR R4)     │
           └─────────────────┘  └─────────────┘  └─────────────────┘
```

### SAR-2: 모듈 의존성

| 모듈 | 의존 대상 | 목적 |
|------|----------|------|
| **hl7_gateway** | mllp_transport, message_parser | HL7 메시지 처리 |
| **fhir_gateway** | http_server, json_parser | FHIR REST API |
| **message_router** | queue_manager, config | 메시지 라우팅 로직 |
| **translation_layer** | hl7_dicom_mapper, fhir_mapper | 프로토콜 변환 |
| **pacs_adapter** | pacs_system (외부) | DICOM 서비스 통합 |

### SAR-3: 스레드 모델 요구사항

| 요구사항 | 설명 |
|----------|------|
| IO 스레드 풀 | MLLP/HTTP 연결 처리 |
| 메시지 워커 풀 | HL7/FHIR 메시지 처리 |
| 변환 워커 | 프로토콜 변환 작업 |
| 큐 관리자 | 아웃바운드 메시지 전달 |
| 타이머 스레드 | 재시도 스케줄링, 타임아웃 |

---

## 프로토콜 적합성 요구사항

### PCR-1: HL7 v2.x 적합성

#### 지원 버전
| 버전 | 지원 수준 |
|------|----------|
| 2.3 | 완전 지원 |
| 2.3.1 | 완전 지원 |
| 2.4 | 완전 지원 |
| 2.5 | 완전 지원 |
| 2.5.1 | 완전 지원 (권장) |

#### 지원 메시지 유형
| 메시지 | 트리거 | 방향 | 우선순위 |
|--------|--------|------|----------|
| ADT | A01, A04, A08, A40 | 인바운드 | 필수 |
| ORM | O01 | 양방향 | 필수 |
| ORU | R01 | 아웃바운드 | 권장 |
| SIU | S12-S15 | 인바운드 | 권장 |
| ACK | * | 양방향 | 필수 |

### PCR-2: IHE 통합 프로파일 적합성

#### Scheduled Workflow (SWF) 트랜잭션
| 트랜잭션 | 액터 역할 | 우선순위 |
|----------|----------|----------|
| RAD-2 (오더 접수) | 수신자 | 필수 |
| RAD-3 (오더 응답) | 송신자 | 권장 |
| RAD-4 (검사 예약) | 송신자 | 필수 |
| RAD-6 (MPPS 시작) | 수신자 | 필수 |
| RAD-7 (MPPS 완료) | 수신자 | 필수 |

---

## 통합 요구사항

### IR-1: pacs_system 통합

| 컴포넌트 | 통합 유형 | 목적 |
|----------|----------|------|
| **worklist_scp** | DICOM 클라이언트 | MWL 항목 업데이트 |
| **mpps_scp** | 이벤트 수신자 | 검사 상태 수신 |
| **storage_scp** | 이벤트 수신자 | 영상 도착 알림 |
| **index_database** | 쿼리 클라이언트 | 환자/스터디 조회 |

### IR-2: kcenon 에코시스템 통합

| 시스템 | 통합 유형 | 목적 |
|--------|----------|------|
| **common_system** | 기반 | Result<T>, 에러 코드 |
| **container_system** | 데이터 레이어 | 메시지 직렬화 |
| **thread_system** | 동시성 | 워커 풀 |
| **logger_system** | 로깅 | 감사 로그, 진단 |
| **monitoring_system** | 관측성 | 메트릭, 헬스 체크 |
| **network_system** | 네트워크 | TCP/TLS, HTTP |

---

## 보안 요구사항

### SR-1: 전송 보안

| 요구사항 | 구현 |
|----------|------|
| TLS 기반 MLLP | HL7 메시지용 TLS 1.2+ |
| HTTPS | FHIR API용 TLS 1.2+ |
| 인증서 검증 | X.509 인증서 체인 검증 |
| 상호 TLS | 선택적 클라이언트 인증서 인증 |

### SR-2: 접근 제어

| 요구사항 | 구현 |
|----------|------|
| IP 화이트리스트 | 소스 IP 기반 연결 제한 |
| 애플리케이션 인증 | HL7 MSH-3/4 검증 |
| API 인증 | FHIR용 OAuth 2.0 / API 키 |
| 역할 기반 접근 | 관리자, 운영자, 읽기 전용 역할 |

### SR-3: 감사 및 컴플라이언스

| 요구사항 | 구현 |
|----------|------|
| 감사 로깅 | 모든 메시지 트랜잭션 로깅 |
| PHI 추적 | 환자 데이터 접근 로깅 |
| HIPAA 준수 | 암호화, 접근 로그, 감사 추적 |
| 로그 보관 | 설정 가능한 보관 기간 |

---

## 성능 요구사항

### PR-1: 벤치마크

| 지표 | 목표 | 테스트 시나리오 |
|------|------|----------------|
| HL7 메시지 처리량 | ≥500 msg/s | ORM 처리 |
| HL7 메시지 지연시간 (P50) | <20 ms | 종단간 |
| HL7 메시지 지연시간 (P99) | <100 ms | 종단간 |
| MLLP 연결 설정 | <10 ms | TCP 핸드셰이크 |
| MWL 항목 생성 | <50 ms | ORM → DICOM |
| 큐 깊이 처리 | 10K 메시지 | 버스트 트래픽 |

### PR-2: 용량 목표

| 지표 | 목표 |
|------|------|
| 일일 메시지 볼륨 | 100K+ 메시지 |
| 동시 HL7 연결 | 50+ |
| 활성 MWL 항목 | 10K+ |
| 메시지 큐 용량 | 50K 메시지 |

---

## 개발 단계

### Phase 1: 핵심 HL7 게이트웨이 (1-6주)

**목표**: HL7 v2.x 메시지 처리 및 MWL 통합 구축

| 산출물 | 설명 | 완료 기준 |
|--------|------|----------|
| HL7 파서 | v2.x 메시지 파서 | ADT, ORM 메시지 파싱 |
| MLLP 전송 | 서버 및 클라이언트 | 연결 처리 |
| ORM→MWL 매퍼 | 오더를 MWL로 변환 | DICOM MWL 항목 생성 |
| ACK 생성기 | 응답 처리 | 적절한 AA/AE/AR 응답 |
| pacs_system 어댑터 | MWL 통합 | DICOM으로 워크리스트 업데이트 |
| 단위 테스트 | 핵심 모듈 테스트 | 80%+ 커버리지 |

**의존성**: pacs_system v0.2.0+, network_system

### Phase 2: MPPS 및 양방향 흐름 (7-10주)

**목표**: MPPS 알림 및 아웃바운드 HL7 구현

| 산출물 | 설명 | 완료 기준 |
|--------|------|----------|
| MPPS 수신기 | 이벤트 핸들러 | N-CREATE/N-SET 수신 |
| MPPS→HL7 매퍼 | 상태 변환 | ORM 상태 업데이트 생성 |
| MLLP 클라이언트 | 아웃바운드 메시징 | RIS로 전송 |
| 메시지 큐 | 신뢰할 수 있는 전달 | 백오프 재시도 |
| 통합 테스트 | 종단간 테스트 | 전체 워크플로우 |

**의존성**: Phase 1 완료

### Phase 3: FHIR 게이트웨이 및 리포팅 (11-16주)

**목표**: FHIR R4 지원 및 리포트 통합 추가

| 산출물 | 설명 | 완료 기준 |
|--------|------|----------|
| FHIR 서버 | REST API | CRUD 작업 |
| 리소스 매퍼 | FHIR↔DICOM | ImagingStudy, ServiceRequest |
| ORU 생성기 | 리포트 메시지 | 예비/최종 리포트 |
| 구독 | 이벤트 알림 | REST-hook 지원 |
| API 문서 | OpenAPI 명세 | 완전한 API 문서 |

**의존성**: Phase 2 완료

### Phase 4: 프로덕션 강화 (17-20주)

**목표**: 보안, 신뢰성, 운영 준비

| 산출물 | 설명 | 완료 기준 |
|--------|------|----------|
| TLS 지원 | 보안 전송 | TLS 1.3 적용 MLLP/HTTPS |
| 설정 | 핫 리로드 | 동적 설정 |
| 모니터링 | 메트릭/헬스 | Prometheus/Grafana 준비 |
| 문서화 | 완전한 문서 | 사용자 가이드, 관리자 가이드 |
| 성능 | 최적화 | 모든 NFR 목표 달성 |

**의존성**: Phase 3 완료

---

## 성공 지표

### 기술 지표

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| HL7 적합성 | 100% 테스트된 메시지 | 적합성 테스트 스위트 |
| IHE SWF 준수 | RAD-2,4,6,7 | IHE 커넥터톤 테스트 |
| 코드 커버리지 | ≥80% | CI 커버리지 리포트 |
| CI/CD 성공 | 100% 성공 | GitHub Actions |
| API 문서화 | 100% 공개 API | 생성된 문서 |

### 성능 지표

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| 메시지 처리량 | ≥500 msg/s | 부하 테스트 |
| 지연시간 P95 | <50 ms | 성능 테스트 |
| 큐 복구 | <30초 | 재시작 테스트 |
| 메모리 기준선 | <200 MB | 프로파일링 |

### 운영 지표

| 지표 | 목표 | 측정 방법 |
|------|------|----------|
| 메시지 전달 | 100% | 트랜잭션 로그 |
| 시스템 가동시간 | 99.9% | 모니터링 |
| 오류율 | <0.1% | 오류 로그 |
| 복구 시간 | <5분 | 장애 테스트 |

---

## 위험 요소 및 대응방안

### 기술적 위험

| 위험 | 영향 | 확률 | 대응방안 |
|------|------|------|----------|
| HL7 구현 다양성 | 높음 | 높음 | 설정 가능한 매핑, 검증 |
| pacs_system API 변경 | 중간 | 낮음 | 버전 고정, 어댑터 패턴 |
| 성능 병목 | 중간 | 중간 | 조기 벤치마킹, 비동기 설계 |
| 복잡한 FHIR 매핑 | 중간 | 중간 | Phase 3로 연기, 점진적 구현 |

### 통합 위험

| 위험 | 영향 | 확률 | 대응방안 |
|------|------|------|----------|
| HIS/RIS 호환성 문제 | 높음 | 높음 | 실제 시스템으로 광범위한 테스트 |
| 메시지 순서 문제 | 중간 | 중간 | 시퀀스 추적, 멱등성 |
| 네트워크 신뢰성 | 중간 | 중간 | 재시도 로직, 큐 영속화 |

### 운영 위험

| 위험 | 영향 | 확률 | 대응방안 |
|------|------|------|----------|
| 설정 오류 | 높음 | 중간 | 검증, 기본값, 드라이런 모드 |
| 인증서 만료 | 중간 | 중간 | 모니터링, 자동 갱신 |
| 큐 오버플로우 | 중간 | 낮음 | 백프레셔, 알림 |

---

## 부록

### 부록 A: HL7 → DICOM MWL 매핑 요약

| HL7 필드 | DICOM 태그 | DICOM 키워드 |
|----------|-----------|--------------|
| PID-3 | (0010,0020) | PatientID |
| PID-5 | (0010,0010) | PatientName |
| PID-7 | (0010,0030) | PatientBirthDate |
| PID-8 | (0010,0040) | PatientSex |
| ORC-2 | (0040,2016) | PlacerOrderNumberIS |
| ORC-3 | (0008,0050) | AccessionNumber |
| OBR-4 | (0032,1064) | RequestedProcedureCodeSequence |
| OBR-7 | (0040,0002/0003) | ScheduledProcedureStepStartDate/Time |
| OBR-24 | (0008,0060) | Modality |
| ZDS-1 | (0020,000D) | StudyInstanceUID |

### 부록 B: MPPS → HL7 상태 매핑

| MPPS 상태 | ORC-1 | ORC-5 | 설명 |
|-----------|-------|-------|------|
| IN PROGRESS | SC | IP | 검사 시작 |
| COMPLETED | SC | CM | 검사 완료 |
| DISCONTINUED | DC | CA | 검사 중단 |

### 부록 C: 오류 코드 레지스트리

```
pacs_bridge 오류 코드: -900 ~ -999

HL7 파싱 오류 (-900 ~ -919):
  -900: INVALID_HL7_MESSAGE (잘못된 HL7 메시지)
  -901: MISSING_MSH_SEGMENT (MSH 세그먼트 누락)
  -902: INVALID_SEGMENT_STRUCTURE (잘못된 세그먼트 구조)
  -903: MISSING_REQUIRED_FIELD (필수 필드 누락)
  -904: INVALID_FIELD_VALUE (잘못된 필드 값)
  -905: UNKNOWN_MESSAGE_TYPE (알 수 없는 메시지 유형)

MLLP 전송 오류 (-920 ~ -939):
  -920: MLLP_CONNECTION_FAILED (MLLP 연결 실패)
  -921: MLLP_SEND_FAILED (MLLP 전송 실패)
  -922: MLLP_RECEIVE_TIMEOUT (MLLP 수신 타임아웃)
  -923: MLLP_INVALID_FRAME (잘못된 MLLP 프레임)
  -924: MLLP_TLS_HANDSHAKE_FAILED (MLLP TLS 핸드셰이크 실패)

변환 오류 (-940 ~ -959):
  -940: MAPPING_FAILED (매핑 실패)
  -941: MISSING_MAPPING_CONFIG (매핑 설정 누락)
  -942: INVALID_CODE_SYSTEM (잘못된 코드 시스템)
  -943: PATIENT_NOT_FOUND (환자를 찾을 수 없음)
  -944: ORDER_NOT_FOUND (오더를 찾을 수 없음)

큐 오류 (-960 ~ -979):
  -960: QUEUE_FULL (큐 가득 참)
  -961: MESSAGE_EXPIRED (메시지 만료)
  -962: DELIVERY_FAILED (전달 실패)
  -963: RETRY_LIMIT_EXCEEDED (재시도 한도 초과)

pacs_system 통합 오류 (-980 ~ -999):
  -980: PACS_CONNECTION_FAILED (PACS 연결 실패)
  -981: MWL_UPDATE_FAILED (MWL 업데이트 실패)
  -982: MPPS_HANDLER_ERROR (MPPS 핸들러 오류)
  -983: DICOM_TRANSLATION_ERROR (DICOM 변환 오류)
```

### 부록 D: 설정 예시

```yaml
# pacs_bridge.yaml
server:
  name: "PACS_BRIDGE"

hl7:
  listener:
    port: 2575
    tls: false
    max_connections: 50

  outbound:
    - name: "RIS"
      host: "ris.hospital.local"
      port: 2576
      retry_count: 3
      retry_interval: 5000

fhir:
  enabled: false
  port: 8080
  base_url: "/fhir"

pacs_system:
  host: "localhost"
  port: 11112
  ae_title: "PACS_BRIDGE"
  called_ae: "PACS_SCP"

mapping:
  modality_ae_titles:
    CT: ["CT_SCANNER_1", "CT_SCANNER_2"]
    MR: ["MR_SCANNER_1"]
    US: ["US_ROOM_1", "US_ROOM_2"]

logging:
  level: "INFO"
  format: "json"
  file: "/var/log/pacs_bridge/bridge.log"
```

### 부록 E: 참조 문서

- HL7 International: https://www.hl7.org/
- HL7 v2.5.1 명세: https://www.hl7.org/implement/standards/
- FHIR R4 명세: https://hl7.org/fhir/R4/
- IHE 영상의학 기술 프레임워크: https://www.ihe.net/resources/technical_frameworks/#radiology
- DICOM 표준: https://www.dicomstandard.org/
- pacs_system: https://github.com/kcenon/pacs_system

---

*문서 버전: 0.2.0.0*
*작성일: 2025-12-07*
*작성자: kcenon@naver.com*
