# SDS - 시퀀스 다이어그램

> **버전:** 0.2.0.0
> **상위 문서:** [SDS_KO.md](SDS_KO.md)
> **최종 수정일:** 2026-02-08

---

## 목차

- [1. HL7 메시지 처리](#1-hl7-메시지-처리)
- [2. 오더 관리 워크플로우](#2-오더-관리-워크플로우)
- [3. MPPS 알림 흐름](#3-mpps-알림-흐름)
- [4. FHIR API 연산](#4-fhir-api-연산)
- [5. 큐 및 재시도 흐름](#5-큐-및-재시도-흐름)
- [6. 오류 처리 시나리오](#6-오류-처리-시나리오)
- [7. IHE Scheduled Workflow](#7-ihe-scheduled-workflow)

---

## 1. HL7 메시지 처리

### SEQ-001: 인바운드 HL7 메시지 흐름

**추적 대상:** FR-1.1, FR-1.2, FR-1.3

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ HIS/RIS │     │   MLLP   │     │   HL7    │     │  메시지   │     │  핸들러   │
│         │     │  서버    │     │  파서    │     │  라우터   │     │          │
└────┬────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │               │                │                │                │
     │  1. TCP 연결  │                │                │                │
     │──────────────►│                │                │                │
     │               │                │                │                │
     │  2. MLLP 프레임 (VT + 메시지 + FS + CR)        │                │
     │  ┌─────────────────────────────────────┐       │                │
     │  │ <VT>                                │       │                │
     │  │ MSH|^~\&|HIS|FAC|BRIDGE|FAC|...    │       │                │
     │  │ PID|||123456||DOE^JOHN||...        │       │                │
     │  │ ORC|NW|ORD001|...                  │       │                │
     │  │ OBR|1|ORD001||CT^CT CHEST|...      │       │                │
     │  │ <FS><CR>                            │       │                │
     │  └─────────────────────────────────────┘       │                │
     │──────────────►│                │                │                │
     │               │                │                │                │
     │               │ 3. MLLP 언래핑│                │                │
     │               │───────────────►│                │                │
     │               │                │                │                │
     │               │                │ 4. 메시지 파싱                  │
     │               │                │ - 구분자 추출                   │
     │               │                │ - 세그먼트 파싱                 │
     │               │                │ - 구조 검증                     │
     │               │                │                │                │
     │               │                │ 5. 메시지 라우팅                │
     │               │                │───────────────►│                │
     │               │                │                │                │
     │               │                │                │ 6. 핸들러 검색
     │               │                │                │ (ORM^O01 → MWL)
     │               │                │                │───────────────►│
     │               │                │                │                │
     │               │                │                │                │ 7. 처리
     │               │                │                │                │ (SEQ-002 참조)
     │               │                │                │                │
     │               │                │                │◄───────────────│
     │               │                │                │    결과        │
     │               │                │                │                │
     │               │                │◄───────────────│                │
     │               │                │  8. ACK 빌드  │                │
     │               │                │                │                │
     │               │◄───────────────│                │                │
     │               │   ACK 메시지  │                │                │
     │               │                │                │                │
     │  9. MLLP ACK 응답             │                │                │
     │  ┌─────────────────────────────────────┐       │                │
     │  │ <VT>                                │       │                │
     │  │ MSH|^~\&|BRIDGE|FAC|HIS|FAC|...    │       │                │
     │  │ MSA|AA|MSG001|                      │       │                │
     │  │ <FS><CR>                            │       │                │
     │  └─────────────────────────────────────┘       │                │
     │◄──────────────│                │                │                │
     │               │                │                │                │
```

### SEQ-002: ADT 메시지 처리 (환자 캐시 업데이트)

**추적 대상:** FR-4.1.1

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│ HIS/RIS │     │  브릿지   │     │ HL7_DICOM│     │  환자    │
│         │     │  서버    │     │  매퍼    │     │  캐시    │
└────┬────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │               │                │                │
     │  ADT^A01      │                │                │
     │  (환자 입원)   │                │                │
     │──────────────►│                │                │
     │               │                │                │
     │               │ 1. 환자 정보 추출               │
     │               │───────────────►│                │
     │               │                │                │
     │               │                │ 2. HL7→환자 매핑
     │               │                │  PID-3 → patient_id
     │               │                │  PID-5 → patient_name
     │               │                │  PID-7 → birth_date
     │               │                │  PID-8 → sex
     │               │                │                │
     │               │◄───────────────│                │
     │               │  patient_info  │                │
     │               │                │                │
     │               │ 3. 캐시 업데이트│                │
     │               │────────────────────────────────►│
     │               │                │                │
     │               │                │                │ 4. 저장/업데이트
     │               │                │                │ - 기존 확인
     │               │                │                │ - 필드 업데이트
     │               │                │                │ - 타임스탬프 갱신
     │               │                │                │
     │               │◄────────────────────────────────│
     │               │   (성공)       │                │
     │               │                │                │
     │  ACK (AA)     │                │                │
     │◄──────────────│                │                │
     │               │                │                │
```

---

## 2. 오더 관리 워크플로우

### SEQ-003: ORM → MWL 항목 생성

**추적 대상:** FR-3.1.1, FR-3.1.2, FR-3.1.3, FR-3.1.4

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   HIS   │     │  브릿지   │     │ HL7_DICOM│     │   MWL    │     │pacs_system│
│         │     │  서버    │     │  매퍼    │     │  클라이언트│     │  MWL SCP  │
└────┬────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │               │                │                │                │
     │  ORM^O01      │                │                │                │
     │  (신규 오더)   │                │                │                │
     │  ┌─────────────────────────────────────┐       │                │
     │  │ MSH|...|ORM^O01|...                 │       │                │
     │  │ PID|||MRN001||DOE^JOHN||19800101|M  │       │                │
     │  │ ORC|NW|ORD001|||SC|...              │       │                │
     │  │ OBR|1|ORD001||CT^CT CHEST||         │       │                │
     │  │     |202512071000|||...             │       │                │
     │  │ ZDS|1.2.840.113619.2.55.12345|      │       │                │
     │  └─────────────────────────────────────┘       │                │
     │──────────────►│                │                │                │
     │               │                │                │                │
     │               │ 1. ORM을 MWL 데이터셋으로 변환  │                │
     │               │───────────────►│                │                │
     │               │                │                │                │
     │               │                │ 2. 필드 매핑:                   │
     │               │                │  PID-3 → PatientID              │
     │               │                │  PID-5 → PatientName            │
     │               │                │  ORC-3 → AccessionNumber        │
     │               │                │  OBR-4 → RequestedProcedureCode │
     │               │                │  OBR-7 → ScheduledDateTime      │
     │               │                │  ZDS-1 → StudyInstanceUID       │
     │               │                │                │                │
     │               │◄───────────────│                │                │
     │               │  MWL 데이터셋  │                │                │
     │               │                │                │                │
     │               │ 3. 워크리스트에 추가            │                │
     │               │────────────────────────────────►│                │
     │               │                │                │                │
     │               │                │                │ 4. DICOM       │
     │               │                │                │ Association    │
     │               │                │                │───────────────►│
     │               │                │                │                │
     │               │                │                │ 5. N-CREATE    │
     │               │                │                │ (MWL 항목)     │
     │               │                │                │───────────────►│
     │               │                │                │                │
     │               │                │                │◄───────────────│
     │               │                │                │  N-CREATE-RSP  │
     │               │                │                │  (성공)        │
     │               │                │                │                │
     │               │◄────────────────────────────────│                │
     │               │   결과         │                │                │
     │               │                │                │                │
     │  ACK (AA)     │                │                │                │
     │◄──────────────│                │                │                │
     │               │                │                │                │
```

### SEQ-004: 오더 취소

**추적 대상:** FR-3.1.5

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   HIS   │     │  브릿지   │     │   MWL    │     │pacs_system│
│         │     │  서버    │     │  클라이언트│     │  MWL SCP  │
└────┬────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │               │                │                │
     │  ORM^O01      │                │                │
     │  (ORC-1=CA)   │                │                │
     │  ┌─────────────────────────────────────┐       │
     │  │ MSH|...|ORM^O01|...                 │       │
     │  │ ORC|CA|ORD001|||CA|...              │       │
     │  │ OBR|1|ORD001||CT^CT CHEST|...       │       │
     │  └─────────────────────────────────────┘       │
     │──────────────►│                │                │
     │               │                │                │
     │               │ 1. 오더 식별                    │
     │               │ (ORC-1 = CA = 취소)             │
     │               │                │                │
     │               │ 2. 워크리스트 항목 취소         │
     │               │───────────────►│                │
     │               │                │                │
     │               │                │ 3. MWL 조회    │
     │               │                │ AccessionNo로  │
     │               │                │───────────────►│
     │               │                │                │
     │               │                │◄───────────────│
     │               │                │  (항목 발견)   │
     │               │                │                │
     │               │                │ 4. MWL 항목    │
     │               │                │ 삭제           │
     │               │                │───────────────►│
     │               │                │                │
     │               │                │◄───────────────│
     │               │                │  (삭제됨)      │
     │               │                │                │
     │               │◄───────────────│                │
     │               │   (성공)       │                │
     │               │                │                │
     │  ACK (AA)     │                │                │
     │◄──────────────│                │                │
     │               │                │                │
```

---

## 3. MPPS 알림 흐름

### SEQ-005: MPPS 진행 중 → HL7 상태 업데이트

**추적 대상:** FR-3.2.1, FR-3.2.2

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌─────────┐
│ 모달리티  │     │pacs_system│    │  브릿지   │     │DICOM_HL7 │     │   RIS   │
│  (CT)    │     │ MPPS SCP │     │  서버    │     │  매퍼    │     │         │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬────┘
     │                │                │                │                │
     │  [검사 시작]   │                │                │                │
     │                │                │                │                │
     │ 1. N-CREATE    │                │                │                │
     │ (MPPS)         │                │                │                │
     │  ┌────────────────────────────────────────┐     │                │
     │  │ PerformedProcedureStepStatus:          │     │                │
     │  │   "IN PROGRESS"                        │     │                │
     │  │ PerformedStationAETitle: "CT_SCANNER_1"│     │                │
     │  │ PerformedProcedureStepStartDateTime:   │     │                │
     │  │   "20251207100000"                     │     │                │
     │  │ ScheduledStepAttributesSequence:       │     │                │
     │  │   AccessionNumber: "ACC001"            │     │                │
     │  │   StudyInstanceUID: "1.2.3..."         │     │                │
     │  └────────────────────────────────────────┘     │                │
     │───────────────►│                │                │                │
     │                │                │                │                │
     │                │ 2. MPPS 이벤트 전달            │                │
     │                │───────────────►│                │                │
     │                │                │                │                │
     │                │                │ 3. HL7로 변환                  │
     │                │                │───────────────►│                │
     │                │                │                │                │
     │                │                │                │ 4. ORM 빌드    │
     │                │                │                │  ORC-1 = SC    │
     │                │                │                │  ORC-5 = IP    │
     │                │                │                │  OBR-22 = 시작시간
     │                │                │                │                │
     │                │                │◄───────────────│                │
     │                │                │  ORM^O01       │                │
     │                │                │                │                │
     │                │                │ 5. RIS로 송신 (큐 경유)         │
     │                │                │────────────────────────────────►│
     │                │                │                │                │
     │                │                │◄────────────────────────────────│
     │                │                │   ACK (AA)     │                │
     │                │                │                │                │
     │◄───────────────│                │                │                │
     │  N-CREATE-RSP  │                │                │                │
     │                │                │                │                │
```

### SEQ-006: MPPS 완료 → HL7 상태 업데이트

**추적 대상:** FR-3.2.3, FR-3.2.4

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌─────────┐
│ 모달리티  │     │pacs_system│    │  브릿지   │     │DICOM_HL7 │     │   RIS   │
│  (CT)    │     │ MPPS SCP │     │  서버    │     │  매퍼    │     │         │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬────┘
     │                │                │                │                │
     │  [검사 완료]   │                │                │                │
     │                │                │                │                │
     │ 1. N-SET       │                │                │                │
     │ (MPPS)         │                │                │                │
     │  ┌────────────────────────────────────────┐     │                │
     │  │ PerformedProcedureStepStatus:          │     │                │
     │  │   "COMPLETED"                          │     │                │
     │  │ PerformedProcedureStepEndDateTime:     │     │                │
     │  │   "20251207103000"                     │     │                │
     │  │ PerformedSeriesSequence:               │     │                │
     │  │   SeriesInstanceUID: "1.2.3.1..."      │     │                │
     │  │   NumberOfSeriesRelatedInstances: 150  │     │                │
     │  └────────────────────────────────────────┘     │                │
     │───────────────►│                │                │                │
     │                │                │                │                │
     │                │ 2. MPPS 이벤트 전달            │                │
     │                │───────────────►│                │                │
     │                │                │                │                │
     │                │                │ 3. HL7로 변환                  │
     │                │                │───────────────►│                │
     │                │                │                │                │
     │                │                │                │ 4. ORM 빌드    │
     │                │                │                │  ORC-1 = SC    │
     │                │                │                │  ORC-5 = CM    │
     │                │                │                │  OBR-27 = 종료시간
     │                │                │                │                │
     │                │                │◄───────────────│                │
     │                │                │  ORM^O01       │                │
     │                │                │                │                │
     │                │                │ 5. RIS로 송신                  │
     │                │                │────────────────────────────────►│
     │                │                │                │                │
     │                │                │◄────────────────────────────────│
     │                │                │   ACK (AA)     │                │
     │                │                │                │                │
     │◄───────────────│                │                │                │
     │  N-SET-RSP     │                │                │                │
     │                │                │                │                │
```

---

## 4. FHIR API 연산

### SEQ-007: FHIR ServiceRequest 생성

**추적 대상:** FR-2.1.3, FR-2.2.2

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   EMR   │     │   FHIR   │     │FHIR_DICOM│     │   MWL    │     │pacs_system│
│         │     │  서버    │     │  매퍼    │     │  클라이언트│     │          │
└────┬────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │               │                │                │                │
     │  POST /fhir/ServiceRequest     │                │                │
     │  ┌─────────────────────────────────────┐       │                │
     │  │ {                                   │       │                │
     │  │   "resourceType": "ServiceRequest", │       │                │
     │  │   "status": "active",               │       │                │
     │  │   "intent": "order",                │       │                │
     │  │   "subject": {                      │       │                │
     │  │     "reference": "Patient/123"      │       │                │
     │  │   },                                │       │                │
     │  │   "code": {                         │       │                │
     │  │     "coding": [{                    │       │                │
     │  │       "code": "CT_CHEST"            │       │                │
     │  │     }]                              │       │                │
     │  │   },                                │       │                │
     │  │   "occurrenceDateTime": "..."       │       │                │
     │  │ }                                   │       │                │
     │  └─────────────────────────────────────┘       │                │
     │──────────────►│                │                │                │
     │               │                │                │                │
     │               │ 1. 요청 검증                    │                │
     │               │                │                │                │
     │               │ 2. 환자 참조 해결               │                │
     │               │ (GET Patient/123)               │                │
     │               │                │                │                │
     │               │ 3. MWL로 변환                   │                │
     │               │───────────────►│                │                │
     │               │                │                │                │
     │               │                │ 4. FHIR→DICOM 매핑              │
     │               │                │  code → Modality                │
     │               │                │  occurrence → ScheduledDT       │
     │               │                │  subject → PatientID            │
     │               │                │                │                │
     │               │◄───────────────│                │                │
     │               │  MWL 데이터셋  │                │                │
     │               │                │                │                │
     │               │ 5. 워크리스트에 추가            │                │
     │               │────────────────────────────────►│                │
     │               │                │                │                │
     │               │                │                │───────────────►│
     │               │                │                │ DICOM N-CREATE │
     │               │                │                │                │
     │               │                │                │◄───────────────│
     │               │                │                │   성공         │
     │               │                │                │                │
     │               │◄────────────────────────────────│                │
     │               │                │                │                │
     │  201 Created  │                │                │                │
     │  ┌─────────────────────────────────────┐       │                │
     │  │ {                                   │       │                │
     │  │   "resourceType": "ServiceRequest", │       │                │
     │  │   "id": "sr-12345",                 │       │                │
     │  │   "status": "active",               │       │                │
     │  │   ...                               │       │                │
     │  │ }                                   │       │                │
     │  └─────────────────────────────────────┘       │                │
     │◄──────────────│                │                │                │
     │               │                │                │                │
```

### SEQ-008: FHIR ImagingStudy 조회

**추적 대상:** FR-2.1.2, FR-2.2.3

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   EMR   │     │   FHIR   │     │pacs_system│    │  인덱스   │
│         │     │  서버    │     │ Query SCP│     │ 데이터베이스│
└────┬────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │               │                │                │
     │  GET /fhir/ImagingStudy?patient=123            │
     │──────────────►│                │                │
     │               │                │                │
     │               │ 1. 쿼리 매개변수 파싱           │
     │               │                │                │
     │               │ 2. DICOM 스터디 조회            │
     │               │───────────────►│                │
     │               │                │                │
     │               │                │ 3. C-FIND      │
     │               │                │───────────────►│
     │               │                │                │
     │               │                │◄───────────────│
     │               │                │  스터디 결과   │
     │               │                │                │
     │               │◄───────────────│                │
     │               │  DICOM 데이터셋│                │
     │               │                │                │
     │               │ 4. FHIR Bundle로 변환           │
     │               │ (ImagingStudy 리소스)           │
     │               │                │                │
     │  200 OK       │                │                │
     │  ┌─────────────────────────────────────┐       │
     │  │ {                                   │       │
     │  │   "resourceType": "Bundle",         │       │
     │  │   "type": "searchset",              │       │
     │  │   "total": 3,                       │       │
     │  │   "entry": [                        │       │
     │  │     { "resource": { ... } },        │       │
     │  │     ...                             │       │
     │  │   ]                                 │       │
     │  │ }                                   │       │
     │  └─────────────────────────────────────┘       │
     │◄──────────────│                │                │
     │               │                │                │
```

---

## 5. 큐 및 재시도 흐름

### SEQ-009: 메시지 큐 및 재시도

**추적 대상:** FR-4.3.1, FR-4.3.2

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌─────────┐
│  브릿지   │     │   큐     │     │   MLLP   │     │   RIS    │     │  타이머  │
│  서버    │     │ 관리자   │     │  클라이언트│     │          │     │         │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬────┘
     │                │                │                │                │
     │  1. 메시지 큐잉                 │                │                │
     │───────────────►│                │                │                │
     │                │                │                │                │
     │                │ 2. SQLite에 저장                │                │
     │                │ (우선순위, 타임스탬프)          │                │
     │                │                │                │                │
     │◄───────────────│                │                │                │
     │  message_id    │                │                │                │
     │                │                │                │                │
     │                │ 3. 전달을 위해 디큐             │                │
     │                │───────────────►│                │                │
     │                │                │                │                │
     │                │                │ 4. 송신 시도   │                │
     │                │                │───────────────►│                │
     │                │                │                │                │
     │                │                │                │ [RIS 다운]     │
     │                │                │◄───────────────┤                │
     │                │                │  연결 실패     │                │
     │                │                │                │                │
     │                │◄───────────────│                │                │
     │                │  NACK (오류)   │                │                │
     │                │                │                │                │
     │                │ 5. 재시도 스케줄                │                │
     │                │ (지수 백오프)                   │                │
     │                │ next_attempt = now + 5s        │                │
     │                │                │                │                │
     │                │                │                │                │
     │                │                │                │ [5초 후]       │
     │                │                │                │◄───────────────│
     │                │                │                │  타이머 발동   │
     │                │                │                │                │
     │                │ 6. 재시도 전달                  │                │
     │                │───────────────►│                │                │
     │                │                │                │                │
     │                │                │ 7. 송신 시도   │                │
     │                │                │───────────────►│                │
     │                │                │                │                │
     │                │                │◄───────────────│                │
     │                │                │   ACK (AA)     │                │
     │                │                │                │                │
     │                │◄───────────────│                │                │
     │                │  ACK (성공)    │                │                │
     │                │                │                │                │
     │                │ 8. 큐에서 삭제                  │                │
     │                │                │                │                │
```

### SEQ-010: Dead Letter 처리

**추적 대상:** FR-4.3.2, NFR-2.2

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌─────────┐
│   큐     │     │   MLLP   │     │   RIS    │     │  관리자  │
│ 관리자   │     │  클라이언트│     │          │     │  알림   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬────┘
     │                │                │                │
     │  [재시도 1 - 5초]               │                │
     │───────────────►│                │                │
     │                │───────────────►│                │
     │◄───────────────│◄───────────────│                │
     │  (실패)        │                │                │
     │                │                │                │
     │  [재시도 2 - 10초]              │                │
     │───────────────►│                │                │
     │◄───────────────│                │                │
     │  (실패)        │                │                │
     │                │                │                │
     │  [재시도 3 - 20초]              │                │
     │───────────────►│                │                │
     │◄───────────────│                │                │
     │  (실패)        │                │                │
     │                │                │                │
     │  [재시도 4 - 40초]              │                │
     │───────────────►│                │                │
     │◄───────────────│                │                │
     │  (실패)        │                │                │
     │                │                │                │
     │  [재시도 5 - 80초] (최대 재시도)│                │
     │───────────────►│                │                │
     │◄───────────────│                │                │
     │  (실패)        │                │                │
     │                │                │                │
     │  1. Dead Letter 큐로 이동       │                │
     │  (영구 실패)   │                │                │
     │                │                │                │
     │  2. 알림 전송  │                │                │
     │───────────────────────────────────────────────►│
     │                │                │                │
     │                │                │                │ 알림 로그:
     │                │                │                │ "메시지 MSG001
     │                │                │                │  RIS_PRIMARY로
     │                │                │                │  5회 재시도 후
     │                │                │                │  실패"
     │                │                │                │
```

---

## 6. 오류 처리 시나리오

### SEQ-011: 유효하지 않은 HL7 메시지 처리

**추적 대상:** 오류 코드 -900 ~ -908

```
┌─────────┐     ┌──────────┐     ┌──────────┐
│ HIS/RIS │     │   MLLP   │     │   HL7    │
│         │     │  서버    │     │  파서    │
└────┬────┘     └────┬─────┘     └────┬─────┘
     │               │                │
     │  유효하지 않은 HL7              │
     │  (MSH 누락)   │                │
     │──────────────►│                │
     │               │                │
     │               │ 1. 파싱        │
     │               │───────────────►│
     │               │                │
     │               │                │ 오류: -901
     │               │                │ MISSING_MSH_SEGMENT
     │               │                │
     │               │◄───────────────│
     │               │  오류          │
     │               │                │
     │               │ 2. NAK 빌드    │
     │               │ (MSA-1 = AE)   │
     │               │                │
     │  ACK (AE)     │                │
     │  ┌─────────────────────────────────────┐
     │  │ MSH|^~\&|BRIDGE|...|ACK|...         │
     │  │ MSA|AE||MSH 세그먼트 누락|          │
     │  └─────────────────────────────────────┘
     │◄──────────────│                │
     │               │                │
     │               │ 3. 오류 로그   │
     │               │ (상세 정보 포함)│
     │               │                │
```

### SEQ-012: pacs_system 연결 실패

**추적 대상:** 오류 코드 -980 ~ -986

```
┌─────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   HIS   │     │  브릿지   │     │   MWL    │     │pacs_system│
│         │     │  서버    │     │  클라이언트│     │  (다운)   │
└────┬────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │               │                │                │
     │  ORM^O01      │                │                │
     │──────────────►│                │                │
     │               │                │                │
     │               │ 1. MWL로 변환                   │
     │               │ (성공)         │                │
     │               │                │                │
     │               │ 2. MWL에 추가  │                │
     │               │───────────────►│                │
     │               │                │                │
     │               │                │ 3. DICOM       │
     │               │                │ Association    │
     │               │                │───────────────►│
     │               │                │                │
     │               │                │                │ [타임아웃]
     │               │                │◄─ ─ ─ ─ ─ ─ ─ ┤
     │               │                │  연결 실패     │
     │               │                │                │
     │               │◄───────────────│                │
     │               │  오류: -980    │                │
     │               │  PACS_CONNECTION_FAILED         │
     │               │                │                │
     │               │ 4. 재시도를 위해 큐잉           │
     │               │ (로컬 저장)    │                │
     │               │                │                │
     │               │ 5. 임시 ACK 반환               │
     │               │                │                │
     │  ACK (AA)     │                │                │
     │  (전달을 위해 │                │                │
     │   큐잉됨)     │                │                │
     │◄──────────────│                │                │
     │               │                │                │
```

---

## 7. IHE Scheduled Workflow

### SEQ-013: 완전한 IHE SWF 시퀀스

**추적 대상:** PCR-3, IHE SWF 프로파일

```
┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐
│   ADT   │  │  오더   │  │  PACS   │  │ 모달리티 │  │  PACS   │  │   RIS   │
│ 등록    │  │ Placer  │  │ 브릿지  │  │  (CT)   │  │ 서버    │  │         │
└────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘
     │            │            │            │            │            │
     │ RAD-1: 환자 등록                     │            │            │
     │ (ADT^A04)  │            │            │            │            │
     │───────────────────────►│            │            │            │
     │            │            │            │            │            │
     │            │            │ 환자 캐시 업데이트      │            │
     │            │            │────────────────────────►│            │
     │            │            │            │            │            │
     │            │            │            │            │            │
     │            │ RAD-2: Placer 오더                  │            │
     │            │ (ORM^O01)  │            │            │            │
     │            │───────────►│            │            │            │
     │            │            │            │            │            │
     │            │            │ RAD-4: MWL 항목 생성   │            │
     │            │            │────────────────────────►│            │
     │            │            │            │            │            │
     │            │            │            │ RAD-5: MWL 조회         │
     │            │            │            │ (C-FIND)   │            │
     │            │            │            │───────────►│            │
     │            │            │            │            │            │
     │            │            │            │◄───────────│            │
     │            │            │            │  워크리스트 │            │
     │            │            │            │            │            │
     │            │            │            │            │            │
     │            │            │            │ [검사 시작]│            │
     │            │            │            │            │            │
     │            │            │            │ RAD-6: MPPS 진행 중     │
     │            │            │            │ (N-CREATE) │            │
     │            │            │            │───────────►│            │
     │            │            │            │            │            │
     │            │            │◄────────────────────────│            │
     │            │            │  MPPS 이벤트│            │            │
     │            │            │            │            │            │
     │            │            │ 상태 업데이트 (IP)      │            │
     │            │            │───────────────────────────────────────►│
     │            │            │            │            │            │
     │            │            │            │            │            │
     │            │            │            │ [검사 완료]│            │
     │            │            │            │            │            │
     │            │            │            │ RAD-7: MPPS 완료        │
     │            │            │            │ (N-SET)    │            │
     │            │            │            │───────────►│            │
     │            │            │            │            │            │
     │            │            │◄────────────────────────│            │
     │            │            │  MPPS 이벤트│            │            │
     │            │            │            │            │            │
     │            │            │ 상태 업데이트 (CM)      │            │
     │            │            │───────────────────────────────────────►│
     │            │            │            │            │            │
     │            │            │            │ RAD-8: 저장 확인        │
     │            │            │            │ (영상)     │            │
     │            │            │            │───────────►│            │
     │            │            │            │            │            │
     │            │            │            │            │ 영상 저장됨
     │            │            │            │            │            │
```

---

*문서 버전: 0.2.0.0*
*작성일: 2025-12-07*
*작성자: kcenon@naver.com*
