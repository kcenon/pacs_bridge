# 소프트웨어 설계 명세서 - PACS Bridge

> **문서 ID:** PACS-BRIDGE-SDS-001
> **버전:** 0.2.0.0
> **최종 수정일:** 2026-02-08
> **언어:** [English](SDS.md) | **한국어**
> **상태:** 초안

---

## 문서 구성

이 SDS는 유지보수성을 위해 모듈별로 구성되어 있습니다:

| 문서 | 목적 |
|------|------|
| **[SDS_KO.md](SDS_KO.md)** (현재 문서) | 개요, 원칙, 모듈 요약 |
| **[SDS_COMPONENTS.md](SDS_COMPONENTS.md)** | 상세 컴포넌트 설계 |
| **[SDS_INTERFACES.md](SDS_INTERFACES.md)** | 인터페이스 명세 |
| **[SDS_SEQUENCES.md](SDS_SEQUENCES.md)** | 시퀀스 다이어그램 |
| **[SDS_TRACEABILITY.md](SDS_TRACEABILITY.md)** | 요구사항 추적 매트릭스 |

---

## 목차

- [1. 서론](#1-서론)
- [2. 설계 개요](#2-설계-개요)
- [3. 설계 원칙](#3-설계-원칙)
- [4. 모듈 요약](#4-모듈-요약)
- [5. 설계 제약사항](#5-설계-제약사항)
- [6. 설계 결정사항](#6-설계-결정사항)
- [7. 품질 속성](#7-품질-속성)
- [8. 참조](#8-참조)

---

## 1. 서론

### 1.1 목적

이 소프트웨어 설계 명세서(SDS)는 PACS Bridge의 아키텍처 설계와 컴포넌트 구조를 기술합니다. PACS Bridge는 병원 정보 시스템(HIS)과 방사선 정보 시스템(RIS)을 PACS와 연결하는 통합 게이트웨이로, HL7 v2.x, FHIR R4, DICOM 프로토콜을 사용합니다.

이 문서의 역할:
- 구현을 위한 청사진
- 유지보수 및 개선을 위한 참조 문서
- 요구사항과 코드 간의 계약

### 1.2 범위

PACS Bridge가 제공하는 기능:

| 기능 | 설명 |
|------|------|
| **HL7 v2.x 게이트웨이** | HL7 메시지 파싱 및 처리 (ADT, ORM, ORU, SIU) |
| **MLLP 전송** | Minimal Lower Layer Protocol 서버 및 클라이언트 |
| **FHIR R4 게이트웨이** | 현대 EHR 통합을 위한 RESTful API |
| **프로토콜 변환** | HL7 ↔ DICOM, FHIR ↔ DICOM 매핑 |
| **메시지 라우팅** | 설정 가능한 메시지 라우팅 및 큐 관리 |
| **pacs_system 통합** | MWL 업데이트, MPPS 알림, 환자 캐시 |

### 1.3 정의 및 약어

| 용어 | 정의 |
|------|------|
| ADT | Admission, Discharge, Transfer (HL7 메시지 유형) |
| DICOM | Digital Imaging and Communications in Medicine |
| FHIR | Fast Healthcare Interoperability Resources |
| HIS | Hospital Information System (병원 정보 시스템) |
| HL7 | Health Level Seven (의료 메시징 표준) |
| IHE | Integrating the Healthcare Enterprise |
| MLLP | Minimal Lower Layer Protocol |
| MPPS | Modality Performed Procedure Step (검사 수행 단계) |
| MWL | Modality Worklist (모달리티 워크리스트) |
| ORM | Order Message (HL7 처방 메시지) |
| ORU | Observation Result (HL7 결과 메시지) |
| RIS | Radiology Information System (방사선 정보 시스템) |
| SCU | Service Class User |
| SCP | Service Class Provider |
| SIU | Scheduling Information Update (HL7 스케줄 메시지) |
| SWF | Scheduled Workflow (IHE 통합 프로파일) |

### 1.4 문서 규칙

**설계 식별자 형식:** `DES-<모듈>-<번호>`

| 모듈 ID | 설명 |
|---------|------|
| HL7 | HL7 게이트웨이 모듈 |
| MLLP | MLLP 전송 모듈 |
| FHIR | FHIR 게이트웨이 모듈 |
| TRANS | 변환 계층 모듈 |
| ROUTE | 메시지 라우팅 모듈 |
| PACS | pacs_system 어댑터 모듈 |
| CFG | 설정 모듈 |
| INT | 통합 어댑터 모듈 |

---

## 2. 설계 개요

### 2.1 고수준 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              PACS Bridge                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                        게이트웨이 계층                                 │ │
│   │                                                                        │ │
│   │   ┌─────────────────────┐          ┌─────────────────────┐           │ │
│   │   │    HL7 게이트웨이   │          │   FHIR 게이트웨이   │           │ │
│   │   │                     │          │                     │           │ │
│   │   │  ┌───────────────┐  │          │  ┌───────────────┐  │           │ │
│   │   │  │ MLLP 서버     │  │          │  │ REST 서버     │  │           │ │
│   │   │  │ (포트 2575)   │  │          │  │ (포트 8080)   │  │           │ │
│   │   │  └───────────────┘  │          │  └───────────────┘  │           │ │
│   │   │  ┌───────────────┐  │          │  ┌───────────────┐  │           │ │
│   │   │  │ MLLP 클라이언트│ │          │  │ REST 클라이언트│ │           │ │
│   │   │  │ (아웃바운드)  │  │          │  │ (Webhook)     │  │           │ │
│   │   │  └───────────────┘  │          │  └───────────────┘  │           │ │
│   │   │  ┌───────────────┐  │          │  ┌───────────────┐  │           │ │
│   │   │  │ 메시지 파서   │  │          │  │ JSON 파서     │  │           │ │
│   │   │  └───────────────┘  │          │  └───────────────┘  │           │ │
│   │   └─────────────────────┘          └─────────────────────┘           │ │
│   └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                       │
│                                      ▼                                       │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                        메시지 라우터                                   │ │
│   │                                                                        │ │
│   │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐            │ │
│   │   │ 인바운드      │  │ 아웃바운드    │  │ 큐            │            │ │
│   │   │ 핸들러        │  │ 핸들러        │  │ 매니저        │            │ │
│   │   └───────────────┘  └───────────────┘  └───────────────┘            │ │
│   └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                       │
│                                      ▼                                       │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                        변환 계층                                       │ │
│   │                                                                        │ │
│   │   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐ │ │
│   │   │ HL7→DICOM   │  │ DICOM→HL7   │  │ FHIR→DICOM  │  │ HL7→FHIR    │ │ │
│   │   │ 매퍼        │  │ 매퍼        │  │ 매퍼        │  │ 매퍼        │ │ │
│   │   └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘ │ │
│   └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                       │
│                                      ▼                                       │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                    pacs_system 어댑터                                  │ │
│   │                                                                        │ │
│   │   ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐   │ │
│   │   │ MWL 클라이언트  │  │ MPPS 핸들러     │  │ 환자 캐시           │   │ │
│   │   │ (C-FIND/Update) │  │ (N-CREATE/SET)  │  │ (인메모리)          │   │ │
│   │   └─────────────────┘  └─────────────────┘  └─────────────────────┘   │ │
│   └───────────────────────────────────────────────────────────────────────┘ │
│                                      │                                       │
│   ┌───────────────────────────────────────────────────────────────────────┐ │
│   │                     통합 계층                                          │ │
│   │                                                                        │ │
│   │   ┌───────────────┐  ┌───────────────┐  ┌───────────────┐            │ │
│   │   │ network_system│  │ thread_system │  │ logger_system │            │ │
│   │   │ 어댑터        │  │ 어댑터        │  │ 어댑터        │            │ │
│   │   └───────────────┘  └───────────────┘  └───────────────┘            │ │
│   └───────────────────────────────────────────────────────────────────────┘ │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                       │
          ┌────────────────────────────┼────────────────────────────┐
          │                            │                            │
          ▼                            ▼                            ▼
┌─────────────────────┐   ┌─────────────────────┐   ┌─────────────────────┐
│     pacs_system     │   │      HIS / RIS      │   │      EMR / EHR      │
│   (DICOM MWL/MPPS)  │   │    (HL7 v2.x)       │   │     (FHIR R4)       │
└─────────────────────┘   └─────────────────────┘   └─────────────────────┘
```

### 2.2 계층형 아키텍처

PACS Bridge는 엄격한 계층형 아키텍처를 따릅니다:

```
┌─────────────────────────────────────────────────────────────────┐
│ 계층 4: 게이트웨이 계층                                         │
│   - HL7 게이트웨이 (MLLP 서버/클라이언트, 메시지 파서)         │
│   - FHIR 게이트웨이 (REST 서버, 리소스 핸들러)                 │
├─────────────────────────────────────────────────────────────────┤
│ 계층 3: 라우팅 계층                                             │
│   - 메시지 라우터 (인바운드/아웃바운드 핸들러)                 │
│   - 큐 매니저 (영속성, 재시도 로직)                            │
├─────────────────────────────────────────────────────────────────┤
│ 계층 2: 변환 계층                                               │
│   - HL7 ↔ DICOM 매퍼                                           │
│   - FHIR ↔ DICOM 매퍼                                          │
│   - HL7 ↔ FHIR 매퍼                                            │
├─────────────────────────────────────────────────────────────────┤
│ 계층 1: pacs_system 어댑터                                      │
│   - MWL 클라이언트 (DICOM C-FIND/Update)                       │
│   - MPPS 핸들러 (N-CREATE/N-SET)                               │
│   - 환자 캐시 (인메모리, TTL 기반)                             │
├─────────────────────────────────────────────────────────────────┤
│ 계층 0: 통합 계층 (kcenon 에코시스템)                           │
│   - network_system (TCP/TLS, HTTP)                             │
│   - thread_system (워커 풀)                                    │
│   - logger_system (감사 로깅)                                  │
│   - container_system (직렬화)                                  │
│   - common_system (Result<T>, 에러 코드)                       │
└─────────────────────────────────────────────────────────────────┘
```

**계층 의존성:**
- 상위 계층은 하위 계층에만 의존
- 순환 의존성 없음
- 통합 계층이 모든 모듈의 기반 제공

---

## 3. 설계 원칙

### 3.1 SOLID 원칙

| 원칙 | PACS Bridge 적용 |
|------|------------------|
| **단일 책임** | 각 모듈은 하나의 프로토콜 도메인만 처리 |
| **개방-폐쇄** | 매퍼 인터페이스는 새 메시지 타입에 확장 가능 |
| **리스코프 치환** | 모든 매퍼는 공통 인터페이스 구현 |
| **인터페이스 분리** | 파싱, 매핑, 직렬화를 위한 별도 인터페이스 |
| **의존성 역전** | 고수준 라우팅은 매퍼 추상화에 의존 |

### 3.2 설계 패턴

| 패턴 | 용도 |
|------|------|
| **팩토리** | 타입별 메시지 파서 생성 |
| **전략** | 라우팅 전략 (직접, 큐, 페일오버) |
| **옵저버** | MPPS 이벤트 구독자 알림 |
| **어댑터** | pacs_system ↔ Bridge 통합 |
| **책임 연쇄** | 메시지 검증 파이프라인 |
| **빌더** | HL7 메시지 구성 |

### 3.3 에러 처리 전략

모든 공개 API는 `common::Result<T>`를 반환합니다:

```cpp
namespace pacs::bridge {

// 에러 처리 패턴
template<typename T>
using Result = common::Result<T>;

// 사용 예시
Result<hl7_message> parse_message(std::string_view raw) {
    if (raw.empty()) {
        return Result<hl7_message>::err(-900, "Empty message");
    }
    // ...
}

} // namespace pacs::bridge
```

### 3.4 스레드 안전성

| 컴포넌트 | 스레드 안전성 보장 |
|----------|-------------------|
| 메시지 파서 | 스레드 안전 (상태 없음) |
| MLLP 서버 | 스레드 안전 (연결별 격리) |
| 메시지 큐 | 스레드 안전 (가능한 경우 락프리) |
| 환자 캐시 | 스레드 안전 (읽기-쓰기 락) |
| 매퍼 | 스레드 안전 (상태 없음) |

---

## 4. 모듈 요약

### 4.1 모듈 개요

| 모듈 | 네임스페이스 | 책임 |
|------|-------------|------|
| **HL7 게이트웨이** | `pacs::bridge::hl7` | HL7 v2.x 메시지 처리 |
| **MLLP 전송** | `pacs::bridge::mllp` | MLLP 네트워크 프로토콜 |
| **FHIR 게이트웨이** | `pacs::bridge::fhir` | FHIR R4 REST API |
| **변환** | `pacs::bridge::mapping` | 프로토콜 변환 |
| **라우팅** | `pacs::bridge::router` | 메시지 라우팅 및 큐 |
| **PACS 어댑터** | `pacs::bridge::pacs_adapter` | pacs_system 통합 |
| **설정** | `pacs::bridge::config` | 설정 관리 |
| **통합** | `pacs::bridge::integration` | kcenon 에코시스템 어댑터 |

### 4.2 컴포넌트 요약 테이블

| 설계 ID | 컴포넌트 | 계층 | 라인 수 (예상) | 의존성 |
|---------|----------|------|---------------|--------|
| DES-HL7-001 | hl7_message | HL7 | 500 | - |
| DES-HL7-002 | hl7_parser | HL7 | 800 | hl7_message |
| DES-HL7-003 | hl7_builder | HL7 | 600 | hl7_message |
| DES-HL7-004 | hl7_validator | HL7 | 400 | hl7_message |
| DES-MLLP-001 | mllp_server | MLLP | 700 | network_adapter |
| DES-MLLP-002 | mllp_client | MLLP | 500 | network_adapter |
| DES-MLLP-003 | mllp_connection | MLLP | 400 | network_adapter |
| DES-FHIR-001 | fhir_server | FHIR | 600 | network_adapter |
| DES-FHIR-002 | fhir_resource | FHIR | 500 | - |
| DES-TRANS-001 | hl7_dicom_mapper | 변환 | 1000 | pacs::core |
| DES-TRANS-002 | dicom_hl7_mapper | 변환 | 800 | pacs::core |
| DES-TRANS-003 | fhir_dicom_mapper | 변환 | 600 | pacs::core |
| DES-ROUTE-001 | message_router | 라우팅 | 600 | - |
| DES-ROUTE-002 | queue_manager | 라우팅 | 800 | thread_adapter |
| DES-PACS-001 | mwl_client | PACS 어댑터 | 500 | pacs_system |
| DES-PACS-002 | mpps_handler | PACS 어댑터 | 400 | pacs_system |
| DES-PACS-003 | patient_cache | PACS 어댑터 | 300 | - |
| DES-CFG-001 | bridge_config | 설정 | 400 | container_system |

---

## 5. 설계 제약사항

### 5.1 기술적 제약사항

| ID | 제약사항 | 근거 |
|----|----------|------|
| **C1** | DICOM 서비스는 pacs_system v0.2.0+ 사용 필수 | 핵심 PACS 의존성 |
| **C2** | kcenon 에코시스템만 사용 (외부 라이브러리 없음) | 에코시스템 일관성 |
| **C3** | C++20 표준 필수 | 최신 언어 기능 |
| **C4** | 크로스 플랫폼 (Linux, macOS, Windows) | 배포 유연성 |
| **C5** | HL7 v2.3.1 ~ v2.9 호환성 | 레거시 시스템 지원 |

### 5.2 프로토콜 제약사항

| ID | 제약사항 | 근거 |
|----|----------|------|
| **PC1** | IHE SWF 프로파일 준수 | 산업 상호운용성 |
| **PC2** | MLLP 프레이밍 (VT/FS/CR) 필수 | HL7 전송 표준 |
| **PC3** | FHIR R4 리소스 형식 | 현대 EHR 호환성 |
| **PC4** | DICOM MWL SOP 클래스 지원 | 워크리스트 통합 |

### 5.3 성능 제약사항

| ID | 제약사항 | 목표 |
|----|----------|------|
| **PF1** | 메시지 처리량 | ≥500 msg/s |
| **PF2** | 메시지 지연시간 (P95) | <50 ms |
| **PF3** | 동시 연결 수 | ≥50 |
| **PF4** | 메모리 기본 사용량 | <200 MB |

---

## 6. 설계 결정사항

### 6.1 주요 설계 결정

#### DD-001: HL7 파서 전략

**결정:** 세그먼트 기반 검증을 포함한 스트리밍 파서

**근거:**
- 가변 길이 메시지를 효율적으로 처리
- 파싱하면서 각 세그먼트 검증
- Z-세그먼트 (커스텀 확장) 지원

**고려된 대안:**
- DOM 스타일 파서: 메모리 오버헤드로 기각
- 정규식 기반: 복잡성으로 기각

#### DD-002: 메시지 큐 영속성

**결정:** SQLite 기반 영속 큐

**근거:**
- 프로세스 재시작 시에도 유지
- 메시지 전달을 위한 ACID 보장
- pacs_system 접근 방식과 일관성

**고려된 대안:**
- 인메모리만: 신뢰성 때문에 기각
- 외부 MQ: 의존성 제약으로 기각

#### DD-003: 환자 캐시 전략

**결정:** TTL과 LRU 제거 정책을 가진 인메모리 캐시

**근거:**
- 반복적인 환자 참조에 대한 빠른 조회
- 제한된 메모리 사용
- 데이터 최신성을 위한 설정 가능한 TTL

**설정 예시:**
```yaml
patient_cache:
  max_entries: 10000
  ttl_seconds: 3600
  eviction_policy: "lru"
```

#### DD-004: 변환 매핑 접근 방식

**결정:** 코드 조회를 포함한 테이블 기반 매핑

**근거:**
- 코드 변경 없이 설정 가능
- 사이트별 코드 매핑 지원
- 감사 및 유지보수 용이

**매핑 테이블 예시:**
```yaml
modality_mapping:
  CT: "1.2.840.10008.5.1.4.1.1.2"    # CT Image Storage
  MR: "1.2.840.10008.5.1.4.1.1.4"    # MR Image Storage
  US: "1.2.840.10008.5.1.4.1.1.6.1"  # US Image Storage
```

#### DD-005: 에러 코드 할당

**결정:** pacs_bridge용 에러 코드 -900 ~ -999 할당

**근거:**
- pacs_system (-800 ~ -899)과 비중복
- 에코시스템 에러 처리와 일관성
- 에러 출처 식별 용이

---

## 7. 품질 속성

### 7.1 성능

| 속성 | 목표 | 구현 |
|------|------|------|
| 처리량 | ≥500 msg/s | 비동기 I/O, 스레드 풀 |
| 지연시간 (P50) | <20 ms | 락프리 큐 |
| 지연시간 (P99) | <100 ms | 연결 풀링 |
| 메모리 | <200 MB | 제한된 캐시, 스트리밍 |

### 7.2 신뢰성

| 속성 | 목표 | 구현 |
|------|------|------|
| 메시지 전달 | 100% | 영속 큐 |
| 가용 시간 | 99.9% | 점진적 성능 저하 |
| 에러 복구 | 자동 | 백오프를 통한 재시도 |
| 데이터 무결성 | 보장 | 트랜잭션 격리 |

### 7.3 유지보수성

| 속성 | 목표 | 구현 |
|------|------|------|
| 코드 커버리지 | ≥80% | 단위 및 통합 테스트 |
| 모듈성 | 높음 | 계층형 아키텍처 |
| 문서화 | 완전 | Doxygen, API 문서 |
| 설정 | 외부화 | YAML/JSON 설정 파일 |

### 7.4 보안

| 속성 | 목표 | 구현 |
|------|------|------|
| 전송 | TLS 1.2+ | MLLP/HTTPS 암호화 |
| 인증 | X.509 | 인증서 기반 |
| 감사 | 완전 | 모든 트랜잭션 로깅 |
| 입력 검증 | 100% | 스키마 검증 |

---

## 8. 참조

### 8.1 표준

| 표준 | 참조 |
|------|------|
| HL7 v2.5.1 | https://www.hl7.org/implement/standards/ |
| FHIR R4 | https://hl7.org/fhir/R4/ |
| DICOM | https://www.dicomstandard.org/ |
| IHE SWF | https://www.ihe.net/Technical_Framework/ |
| MLLP | https://www.hl7.org/implement/standards/product_brief.cfm?product_id=55 |

### 8.2 관련 문서

| 문서 | 설명 |
|------|------|
| [PRD_KO.md](PRD_KO.md) | 제품 요구사항 문서 |
| [SRS_KO.md](SRS_KO.md) | 소프트웨어 요구사항 명세서 |
| pacs_system SDS | 핵심 PACS 설계 참조 |

### 8.3 참조 자료

| 문서 | 설명 |
|------|------|
| [01_hl7_v2x_overview.md](reference_materials/01_hl7_v2x_overview.md) | HL7 v2.x 기초 |
| [02_hl7_message_types.md](reference_materials/02_hl7_message_types.md) | ADT, ORM, ORU, SIU 명세 |
| [03_hl7_segments.md](reference_materials/03_hl7_segments.md) | 세그먼트 구조 |
| [04_mllp_protocol.md](reference_materials/04_mllp_protocol.md) | MLLP 전송 |
| [05_fhir_radiology.md](reference_materials/05_fhir_radiology.md) | FHIR R4 방사선학 |
| [06_ihe_swf_profile.md](reference_materials/06_ihe_swf_profile.md) | IHE SWF 프로파일 |
| [07_dicom_hl7_mapping.md](reference_materials/07_dicom_hl7_mapping.md) | DICOM-HL7 매핑 |
| [08_mwl_hl7_integration.md](reference_materials/08_mwl_hl7_integration.md) | MWL 통합 |

---

*문서 버전: 0.2.0.0*
*작성일: 2025-12-07*
*작성자: kcenon@naver.com*
